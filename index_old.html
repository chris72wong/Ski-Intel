<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ski Conditions</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header class="header">
        <div class="container">
            <h1>‚õ∑Ô∏è Ski Intel</h1>
            <p class="tagline">Real-time ski conditions and travel info</p>
        </div>
    </header>

    <main class="container">
        <!-- Weather Section -->
        <section class="card">
            <div class="card-header">
                <h2>üå®Ô∏è Weather - Ellicottville, NY</h2>
                <p class="last-updated" id="weather-updated">Loading...</p>
            </div>
            <div class="card-content">
                <div id="weather-error" class="error-message" style="display: none;"></div>
                <div class="info-grid" id="weather-data">
                    <div class="info-item">
                        <span class="label">Temperature</span>
                        <span class="value loading-placeholder">--¬∞C</span>
                    </div>
                    <div class="info-item">
                        <span class="label">Conditions</span>
                        <span class="value loading-placeholder">--</span>
                    </div>
                    <div class="info-item">
                        <span class="label">Wind Speed</span>
                        <span class="value loading-placeholder">-- km/h</span>
                    </div>
                    <div class="info-item">
                        <span class="label">Precipitation</span>
                        <span class="value loading-placeholder">-- mm</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- NOAA Snow Depth Section -->
        <section class="card">
            <div class="card-header">
                <h2>‚ùÑÔ∏è NOAA Snow Depth</h2>
                <p class="last-updated" id="noaa-updated">Loading...</p>
            </div>
            <div class="card-content">
                <div id="noaa-error" class="error-message" style="display: none;"></div>
                <div class="info-grid" id="noaa-data">
                    <div class="info-item">
                        <span class="label">Snow Depth</span>
                        <span class="value loading-placeholder">-- cm</span>
                    </div>
                    <div class="info-item">
                        <span class="label">24h Change</span>
                        <span class="value loading-placeholder">-- cm</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- Navigation Section -->
        <section class="card navigation-section">
            <div class="card-header">
                <h2>üó∫Ô∏è Route to Holiday Valley</h2>
                <p class="last-updated" id="route-updated">From Peace Bridge</p>
            </div>
            <div class="card-content">
                <div id="route-error" class="error-message" style="display: none;"></div>
                <div id="route-data">
                    <div class="route-loading">Loading route information...</div>
                </div>
                <div class="map-link" style="display: none;">
                    <a id="google-maps-link" href="#" target="_blank" class="btn-map">Open in Google Maps üîó</a>
                </div>
            </div>
        </section>

        <!-- State Holidays Section -->
        <section class="card">
            <div class="card-header">
                <h2>üìÖ Upcoming Holidays</h2>
            </div>
            <div class="card-content">
                <div class="holiday-grid">
                    <div class="holiday-region">
                        <h3>Ohio</h3>
                        <ul class="holiday-list">
                            <li>
                                <span class="holiday-date">Jan 20</span>
                                <span class="holiday-name">MLK Day</span>
                            </li>
                            <li>
                                <span class="holiday-date">Feb 17</span>
                                <span class="holiday-name">Presidents' Day</span>
                            </li>
                            <li>
                                <span class="holiday-date">May 26</span>
                                <span class="holiday-name">Memorial Day</span>
                            </li>
                        </ul>
                    </div>

                    <div class="holiday-region">
                        <h3>Pennsylvania</h3>
                        <ul class="holiday-list">
                            <li>
                                <span class="holiday-date">Jan 20</span>
                                <span class="holiday-name">MLK Day</span>
                            </li>
                            <li>
                                <span class="holiday-date">Feb 17</span>
                                <span class="holiday-name">Presidents' Day</span>
                            </li>
                            <li>
                                <span class="holiday-date">May 26</span>
                                <span class="holiday-name">Memorial Day</span>
                            </li>
                        </ul>
                    </div>

                    <div class="holiday-region">
                        <h3>New York</h3>
                        <ul class="holiday-list">
                            <li>
                                <span class="holiday-date">Jan 20</span>
                                <span class="holiday-name">MLK Day</span>
                            </li>
                            <li>
                                <span class="holiday-date">Feb 17</span>
                                <span class="holiday-name">Presidents' Day</span>
                            </li>
                            <li>
                                <span class="holiday-date">May 26</span>
                                <span class="holiday-name">Memorial Day</span>
                            </li>
                        </ul>
                    </div>

                    <div class="holiday-region">
                        <h3>Ontario, Canada</h3>
                        <ul class="holiday-list">
                            <li>
                                <span class="holiday-date">Jan 20</span>
                                <span class="holiday-name">Family Day</span>
                            </li>
                            <li>
                                <span class="holiday-date">Mar 17</span>
                                <span class="holiday-name">St. Patrick's Day (obs.)</span>
                            </li>
                            <li>
                                <span class="holiday-date">May 19</span>
                                <span class="holiday-name">Victoria Day</span>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <footer class="footer">
        <p>&copy; 2026 Ski Intel. Stay safe on the slopes!</p>
    </footer>

    <script>
        const ELLICOTTVILLE_LAT = 42.2773;
        const ELLICOTTVILLE_LON = -78.6706;
        const PEACE_BRIDGE = 'Peace Bridge, Buffalo, NY';
        const HOLIDAY_VALLEY = 'Holiday Valley, Ellicottville, NY';
        
        const WEATHER_REFRESH_MS = 6 * 60 * 60 * 1000; // 6 hours
        const NOAA_REFRESH_MS = 6 * 60 * 60 * 1000; // 6 hours
        const ROUTE_REFRESH_MS = 15 * 60 * 1000; // 15 minutes

        const weatherCodeMap = {
            0: 'Clear',
            1: 'Mainly Clear',
            2: 'Partly Cloudy',
            3: 'Overcast',
            45: 'Foggy',
            48: 'Foggy',
            51: 'Light Drizzle',
            53: 'Drizzle',
            55: 'Heavy Drizzle',
            61: 'Light Rain',
            63: 'Rain',
            65: 'Heavy Rain',
            71: 'Light Snow',
            73: 'Snow',
            75: 'Heavy Snow',
            77: 'Snow Grains',
            80: 'Light Showers',
            81: 'Showers',
            82: 'Heavy Showers',
            85: 'Light Snow Showers',
            86: 'Snow Showers',
            95: 'Thunderstorm',
            96: 'Thunderstorm with Hail',
            99: 'Thunderstorm with Hail'
        };

        function formatRelativeTime(date) {
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);

            if (minutes < 1) return 'just now';
            if (minutes < 60) return `${minutes}m ago`;
            if (hours < 24) return `${hours}h ago`;
            return `${days}d ago`;
        }

        function updateRelativeTimes() {
            const weatherTime = localStorage.getItem('weather-timestamp');
            const noaaTime = localStorage.getItem('noaa-timestamp');

            if (weatherTime) {
                document.getElementById('weather-updated').textContent = 
                    `Updated ${formatRelativeTime(new Date(parseInt(weatherTime)))}`;
            }

            if (noaaTime) {
                document.getElementById('noaa-updated').textContent = 
                    `Updated ${formatRelativeTime(new Date(parseInt(noaaTime)))}`;
            }
        }

        async function fetchWeatherData() {
            try {
                const url = `https://api.open-meteo.com/v1/forecast?latitude=${ELLICOTTVILLE_LAT}&longitude=${ELLICOTTVILLE_LON}&current=temperature_2m,weather_code,wind_speed_10m,precipitation&temperature_unit=celsius&wind_speed_unit=kmh`;
                
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                const current = data.current;

                const weatherHTML = `
                    <div class="info-item">
                        <span class="label">Temperature</span>
                        <span class="value">${current.temperature_2m.toFixed(1)}¬∞C</span>
                    </div>
                    <div class="info-item">
                        <span class="label">Conditions</span>
                        <span class="value">${weatherCodeMap[current.weather_code] || 'Unknown'}</span>
                    </div>
                    <div class="info-item">
                        <span class="label">Wind Speed</span>
                        <span class="value">${current.wind_speed_10m.toFixed(1)} km/h</span>
                    </div>
                    <div class="info-item">
                        <span class="label">Precipitation</span>
                        <span class="value">${current.precipitation.toFixed(1)} mm</span>
                    </div>
                `;

                document.getElementById('weather-data').innerHTML = weatherHTML;
                document.getElementById('weather-error').style.display = 'none';
                
                localStorage.setItem('weather-timestamp', Date.now().toString());
                localStorage.setItem('weather-data', JSON.stringify(current));
                
                updateRelativeTimes();
            } catch (error) {
                console.error('Weather fetch error:', error);
                document.getElementById('weather-error').textContent = 
                    `‚ö†Ô∏è Unable to load weather data: ${error.message}`;
                document.getElementById('weather-error').style.display = 'block';
                
                const cached = localStorage.getItem('weather-data');
                if (cached) {
                    const current = JSON.parse(cached);
                    const weatherHTML = `
                        <div class="info-item">
                            <span class="label">Temperature</span>
                            <span class="value">${current.temperature_2m.toFixed(1)}¬∞C</span>
                        </div>
                        <div class="info-item">
                            <span class="label">Conditions</span>
                            <span class="value">${weatherCodeMap[current.weather_code] || 'Unknown'}</span>
                        </div>
                        <div class="info-item">
                            <span class="label">Wind Speed</span>
                            <span class="value">${current.wind_speed_10m.toFixed(1)} km/h</span>
                        </div>
                        <div class="info-item">
                            <span class="label">Precipitation</span>
                            <span class="value">${current.precipitation.toFixed(1)} mm</span>
                        </div>
                    `;
                    document.getElementById('weather-data').innerHTML = weatherHTML + '<p class="cached-note">(Cached data)</p>';
                }
            }
        }

        async function fetchNOAAData() {
            try {
                const pointUrl = `https://api.weather.gov/points/${ELLICOTTVILLE_LAT},${ELLICOTTVILLE_LON}`;
                const pointResponse = await fetch(pointUrl);
                if (!pointResponse.ok) throw new Error(`HTTP ${pointResponse.status}`);
                
                const pointData = await pointResponse.json();
                const stationUrl = pointData.properties.observationStations;
                
                const stationResponse = await fetch(stationUrl);
                if (!stationResponse.ok) throw new Error(`HTTP ${stationResponse.status}`);
                
                const stationData = await stationResponse.json();
                const stationId = stationData.features[0]?.id;
                
                if (!stationId) throw new Error('No station found');
                
                const obsUrl = `${stationId}/observations/latest`;
                const obsResponse = await fetch(obsUrl);
                if (!obsResponse.ok) throw new Error(`HTTP ${obsResponse.status}`);
                
                const obsData = await obsResponse.json();
                const snowDepth = obsData.properties.snowDepth?.value;
                
                let snowDepthCm = 'N/A';
                let change24h = 'N/A';
                
                if (snowDepth !== null && snowDepth !== undefined) {
                    snowDepthCm = (snowDepth * 100).toFixed(1);
                    
                    const prevDepth = localStorage.getItem('noaa-prev-depth');
                    if (prevDepth !== null) {
                        const diff = snowDepth - parseFloat(prevDepth);
                        change24h = (diff > 0 ? '+' : '') + (diff * 100).toFixed(1);
                    }
                    localStorage.setItem('noaa-prev-depth', snowDepth.toString());
                } else {
                    snowDepthCm = 'No data';
                }

                const noaaHTML = `
                    <div class="info-item">
                        <span class="label">Snow Depth</span>
                        <span class="value">${snowDepthCm}${snowDepthCm !== 'No data' && snowDepthCm !== 'N/A' ? ' cm' : ''}</span>
                    </div>
                    <div class="info-item">
                        <span class="label">24h Change</span>
                        <span class="value">${change24h}${change24h !== 'N/A' ? ' cm' : ''}</span>
                    </div>
                `;

                document.getElementById('noaa-data').innerHTML = noaaHTML;
                document.getElementById('noaa-error').style.display = 'none';
                
                localStorage.setItem('noaa-timestamp', Date.now().toString());
                localStorage.setItem('noaa-data', JSON.stringify({ snowDepth, change24h }));
                
                updateRelativeTimes();
            } catch (error) {
                console.error('NOAA fetch error:', error);
                document.getElementById('noaa-error').textContent = 
                    `‚ö†Ô∏è Unable to load NOAA data: ${error.message}`;
                document.getElementById('noaa-error').style.display = 'block';
                
                const cached = localStorage.getItem('noaa-data');
                if (cached) {
                    const data = JSON.parse(cached);
                    const noaaHTML = `
                        <div class="info-item">
                            <span class="label">Snow Depth</span>
                            <span class="value">${data.snowDepth !== null ? (data.snowDepth * 100).toFixed(1) + ' cm' : 'No data'}</span>
                        </div>
                        <div class="info-item">
                            <span class="label">24h Change</span>
                            <span class="value">${data.change24h} cm</span>
                        </div>
                    `;
                    document.getElementById('noaa-data').innerHTML = noaaHTML + '<p class="cached-note">(Cached data)</p>';
                }
            }
        }

        async function fetchBorderData() {
            try {
                // Try using a CORS proxy to access CBP's XML feed
                const corsProxy = 'https://api.allorigins.win/raw?url=';
                const apiUrl = encodeURIComponent('https://bwt.cbp.gov/xml/bwt.xml');
                const response = await fetch(corsProxy + apiUrl);
                
                if (!response.ok) throw new Error(`API not accessible (${response.status})`);
                
                const xmlText = await response.text();
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlText, "text/xml");
                
                console.log('Border XML data received'); // Debug log
                
                // Get all port entries
                const ports = xmlDoc.querySelectorAll('port');
                
                const targetBridges = [
                    { name: 'Buffalo-Peace Bridge', displayName: 'Peace Bridge' },
                    { name: 'Buffalo-Niagara Falls', displayName: 'Rainbow Bridge' },
                    { name: 'Lewiston', displayName: 'Lewiston-Queenston Bridge' }
                ];
                
                let borderHTML = '';
                
                targetBridges.forEach(bridge => {
                    // Find the port matching this bridge
                    for (let port of ports) {
                        const portName = port.querySelector('port_name')?.textContent || '';
                        
                        if (portName.toLowerCase().includes(bridge.name.toLowerCase()) || 
                            portName.toLowerCase().includes(bridge.displayName.toLowerCase())) {
                            
                            // Get passenger vehicle lanes
                            const lanes = port.querySelectorAll('passenger_vehicle_lane');
                            
                            // Get standard lane delay (not NEXUS or SENTRI)
                            let delay = 0;
                            for (let lane of lanes) {
                                const laneType = lane.querySelector('lane_type')?.textContent || '';
                                if (laneType.toLowerCase().includes('standard') || 
                                    (!laneType.toLowerCase().includes('nexus') && !laneType.toLowerCase().includes('sentri'))) {
                                    delay = parseInt(lane.querySelector('delay_minutes')?.textContent || '0');
                                    break;
                                }
                            }
                            
                            // If no standard lane found, try getting any passenger vehicle delay
                            if (delay === 0 && lanes.length > 0) {
                                delay = parseInt(lanes[0].querySelector('delay_minutes')?.textContent || '0');
                            }
                            
                            borderHTML += `
                                <div class="border-banner-item">
                                    <span class="bridge-name">${bridge.displayName}</span>
                                    <span class="bridge-wait">${delay} min</span>
                                </div>
                            `;
                            break;
                        }
                    }
                });
                
                if (!borderHTML) {
                    throw new Error('No matching bridges found in XML data');
                }
                
                document.getElementById('border-banner-data').innerHTML = borderHTML;
                
                localStorage.setItem('border-timestamp', Date.now().toString());
                localStorage.setItem('border-html', borderHTML);
                
                updateRelativeTimes();
            } catch (error) {
                console.error('Border wait times fetch error:', error);
                console.log('Unable to fetch live data. Error:', error.message);
                
                // Try to use cached data
                const cachedHTML = localStorage.getItem('border-html');
                if (cachedHTML) {
                    document.getElementById('border-banner-data').innerHTML = cachedHTML + 
                        '<div class="border-banner-item"><span class="bridge-name" style="font-style: italic; opacity: 0.8;">(Cached data)</span></div>';
                } else {
                    // Show placeholder with link to official site
                    const placeholderHTML = `
                        <div class="border-banner-item border-error-message">
                            <span class="bridge-name">‚ö†Ô∏è Unable to load live data</span>
                            <span class="bridge-wait"><a href="https://bwt.cbp.gov/" target="_blank" style="color: white; text-decoration: underline;">View on CBP ‚Üí</a></span>
                        </div>
                    `;
                    document.getElementById('border-banner-data').innerHTML = placeholderHTML;
                }
                localStorage.setItem('border-timestamp', Date.now().toString());
                updateRelativeTimes();
            }
        }

        async function fetchRouteData() {
            try {
                if (GOOGLE_MAPS_API_KEY === 'YOUR_API_KEY_HERE') {
                    throw new Error('API key not configured');
                }

                const origin = encodeURIComponent(PEACE_BRIDGE);
                const destination = encodeURIComponent(HOLIDAY_VALLEY);
                const url = `https://maps.googleapis.com/maps/api/directions/json?origin=${origin}&destination=${destination}&departure_time=now&traffic_model=best_guess&key=${GOOGLE_MAPS_API_KEY}`;
                
                // Note: Direct fetch from browser will be blocked by CORS
                // Using a fallback with estimated data
                throw new Error('Using estimated route data');
                
            } catch (error) {
                console.log('Route fetch info:', error.message);
                
                // Show estimated route data (approximately 1 hour drive, 50 miles)
                const estimatedDistance = '50 miles (80 km)';
                const estimatedDuration = '1 hour 5 mins';
                const estimatedRoute = 'Via I-90 E and NY-219 S';
                
                const routeHTML = `
                    <div class="route-info">
                        <div class="route-detail">
                            <span class="route-icon">üìç</span>
                            <div class="route-text">
                                <div class="route-label">Distance</div>
                                <div class="route-value">${estimatedDistance}</div>
                            </div>
                        </div>
                        <div class="route-detail">
                            <span class="route-icon">‚è±Ô∏è</span>
                            <div class="route-text">
                                <div class="route-label">Travel Time</div>
                                <div class="route-value">${estimatedDuration}</div>
                            </div>
                        </div>
                        <div class="route-detail">
                            <span class="route-icon">üõ£Ô∏è</span>
                            <div class="route-text">
                                <div class="route-label">Recommended Route</div>
                                <div class="route-value">${estimatedRoute}</div>
                            </div>
                        </div>
                        <div class="route-detail">
                            <span class="route-icon">üí°</span>
                            <div class="route-text">
                                <div class="route-label">Tip</div>
                                <div class="route-value">Check traffic before departure</div>
                            </div>
                        </div>
                    </div>
                    <p class="cached-note">‚ÑπÔ∏è Estimated route - actual times may vary with traffic</p>
                `;
                
                document.getElementById('route-data').innerHTML = routeHTML;
                document.getElementById('route-error').style.display = 'none';
                
                // Update Google Maps link
                const mapsUrl = `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(PEACE_BRIDGE)}&destination=${encodeURIComponent(HOLIDAY_VALLEY)}&travelmode=driving`;
                const linkElement = document.getElementById('google-maps-link');
                linkElement.href = mapsUrl;
                document.querySelector('.map-link').style.display = 'block';
                
                localStorage.setItem('route-timestamp', Date.now().toString());
                updateRelativeTimes();
            }
        }

        function shouldRefresh(timestampKey, intervalMs) {
            const lastUpdate = localStorage.getItem(timestampKey);
            if (!lastUpdate) return true;
            return (Date.now() - parseInt(lastUpdate)) > intervalMs;
        }

        function initData() {
            if (shouldRefresh('weather-timestamp', WEATHER_REFRESH_MS)) {
                fetchWeatherData();
            } else {
                const cached = localStorage.getItem('weather-data');
                if (cached) {
                    const current = JSON.parse(cached);
                    const weatherHTML = `
                        <div class="info-item">
                            <span class="label">Temperature</span>
                            <span class="value">${current.temperature_2m.toFixed(1)}¬∞C</span>
                        </div>
                        <div class="info-item">
                            <span class="label">Conditions</span>
                            <span class="value">${weatherCodeMap[current.weather_code] || 'Unknown'}</span>
                        </div>
                        <div class="info-item">
                            <span class="label">Wind Speed</span>
                            <span class="value">${current.wind_speed_10m.toFixed(1)} km/h</span>
                        </div>
                        <div class="info-item">
                            <span class="label">Precipitation</span>
                            <span class="value">${current.precipitation.toFixed(1)} mm</span>
                        </div>
                    `;
                    document.getElementById('weather-data').innerHTML = weatherHTML;
                }
            }

            if (shouldRefresh('noaa-timestamp', NOAA_REFRESH_MS)) {
                fetchNOAAData();
            } else {
                const cached = localStorage.getItem('noaa-data');
                if (cached) {
                    const data = JSON.parse(cached);
                    const noaaHTML = `
                        <div class="info-item">
                            <span class="label">Snow Depth</span>
                            <span class="value">${data.snowDepth !== null ? (data.snowDepth * 100).toFixed(1) + ' cm' : 'No data'}</span>
                        </div>
                        <div class="info-item">
                            <span class="label">24h Change</span>
                            <span class="value">${data.change24h} cm</span>
                        </div>
                    `;
                    document.getElementById('noaa-data').innerHTML = noaaHTML;
                }
            }

            updateRelativeTimes();
            
            // Initialize route data
            if (shouldRefresh('route-timestamp', ROUTE_REFRESH_MS)) {
                fetchRouteData();
            }
            
            // Initialize border wait times
            if (shouldRefresh('border-timestamp', BORDER_REFRESH_MS)) {
                fetchBorderData();
            } else {
                const cachedHTML = localStorage.getItem('border-html');
                if (cachedHTML) {
                    document.getElementById('border-banner-data').innerHTML = cachedHTML;
                } else {
                    fetchBorderData();
                }
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            initData();
            setInterval(updateRelativeTimes, 60000);
            setInterval(() => {
                if (shouldRefresh('weather-timestamp', WEATHER_REFRESH_MS)) {
                    fetchWeatherData();
                }
            }, 60000);
            setInterval(() => {
                if (shouldRefresh('noaa-timestamp', NOAA_REFRESH_MS)) {
                    fetchNOAAData();
                }
            }, 60000);
            setInterval(() => {
                if (shouldRefresh('border-timestamp', BORDER_REFRESH_MS)) {
                    fetchBorderData();
                }
            }, 60000);
            setInterval(() => {
                if (shouldRefresh('route-timestamp', ROUTE_REFRESH_MS)) {
                    fetchRouteData();
                }
            }, 60000);
        });
    </script>
</body>
</html>
