<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ski Conditions</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header class="header">
        <div class="container">
            <h1>‚õ∑Ô∏è Ski Intel</h1>
            <p class="tagline">Real-time ski conditions and travel info</p>
        </div>
    </header>

    <main class="container">
        <!-- Weather Section -->
        <section class="card">
            <div class="card-header">
                <h2>üå®Ô∏è Weather - Ellicottville, NY</h2>
                <p class="last-updated" id="weather-updated">Loading...</p>
            </div>
            <div class="card-content">
                <div id="weather-error" class="error-message" style="display: none;"></div>
                <div class="info-grid" id="weather-data">
                    <div class="info-item">
                        <span class="label">Temperature</span>
                        <span class="value loading-placeholder">--¬∞C</span>
                    </div>
                    <div class="info-item">
                        <span class="label">Conditions</span>
                        <span class="value loading-placeholder">--</span>
                    </div>
                    <div class="info-item">
                        <span class="label">Wind Speed</span>
                        <span class="value loading-placeholder">-- km/h</span>
                    </div>
                    <div class="info-item">
                        <span class="label">Precipitation</span>
                        <span class="value loading-placeholder">-- mm</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- NOAA Snow Depth Section -->
        <section class="card">
            <div class="card-header">
                <h2>‚ùÑÔ∏è NOAA Snow Depth</h2>
                <p class="last-updated" id="noaa-updated">Loading...</p>
            </div>
            <div class="card-content">
                <div id="noaa-error" class="error-message" style="display: none;"></div>
                <div class="info-grid" id="noaa-data">
                    <div class="info-item">
                        <span class="label">Snow Depth</span>
                        <span class="value loading-placeholder">-- cm</span>
                    </div>
                    <div class="info-item">
                        <span class="label">24h Change</span>
                        <span class="value loading-placeholder">-- cm</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- Border Wait Times Section -->
        <section class="card">
            <div class="card-header">
                <h2>üõÇ Border Wait Times</h2>
                <p class="last-updated" id="border-updated">Loading...</p>
            </div>
            <div class="card-content">
                <div id="border-error" class="error-message" style="display: none;"></div>
                <div id="border-data">
                    <div class="border-loading">Loading bridge wait times...</div>
                </div>
            </div>
        </section>

        <!-- Live Traffic Camera Section -->
        <section class="card camera-section">
            <div class="card-header">
                <h2>üìπ Live Bridge Camera</h2>
                <p class="last-updated">Peace Bridge - US Entry Side</p>
            </div>
            <div class="card-content camera-content">
                <div class="video-wrapper">
                    <iframe 
                        src="https://www.youtube.com/embed/9En2186vo5g" 
                        title="Peace Bridge Live Camera" 
                        frameborder="0" 
                        allow="accelerometer; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" 
                        allowfullscreen>
                    </iframe>
                </div>
            </div>
        </section>

        <!-- Traffic Section -->
        <section class="card">
            <div class="card-header">
                <h2>üöó Traffic Conditions</h2>
            </div>
            <div class="card-content">
                <div class="traffic-item">
                    <div class="route">I-87 North (Northway)</div>
                    <div class="status status-good">‚úì Light</div>
                </div>
                <div class="traffic-item">
                    <div class="route">I-90 East (New York)</div>
                    <div class="status status-moderate">‚ö† Moderate</div>
                </div>
                <div class="traffic-item">
                    <div class="route">Route 20 (Pennsylvania)</div>
                    <div class="status status-good">‚úì Light</div>
                </div>
                <div class="traffic-item">
                    <div class="route">QEW (Ontario)</div>
                    <div class="status status-heavy">‚õî Heavy</div>
                </div>
            </div>
        </section>

        <!-- State Holidays Section -->
        <section class="card">
            <div class="card-header">
                <h2>üìÖ Upcoming Holidays</h2>
            </div>
            <div class="card-content">
                <div class="holiday-grid">
                    <div class="holiday-region">
                        <h3>Ohio</h3>
                        <ul class="holiday-list">
                            <li>
                                <span class="holiday-date">Jan 20</span>
                                <span class="holiday-name">MLK Day</span>
                            </li>
                            <li>
                                <span class="holiday-date">Feb 17</span>
                                <span class="holiday-name">Presidents' Day</span>
                            </li>
                            <li>
                                <span class="holiday-date">May 26</span>
                                <span class="holiday-name">Memorial Day</span>
                            </li>
                        </ul>
                    </div>

                    <div class="holiday-region">
                        <h3>Pennsylvania</h3>
                        <ul class="holiday-list">
                            <li>
                                <span class="holiday-date">Jan 20</span>
                                <span class="holiday-name">MLK Day</span>
                            </li>
                            <li>
                                <span class="holiday-date">Feb 17</span>
                                <span class="holiday-name">Presidents' Day</span>
                            </li>
                            <li>
                                <span class="holiday-date">May 26</span>
                                <span class="holiday-name">Memorial Day</span>
                            </li>
                        </ul>
                    </div>

                    <div class="holiday-region">
                        <h3>New York</h3>
                        <ul class="holiday-list">
                            <li>
                                <span class="holiday-date">Jan 20</span>
                                <span class="holiday-name">MLK Day</span>
                            </li>
                            <li>
                                <span class="holiday-date">Feb 17</span>
                                <span class="holiday-name">Presidents' Day</span>
                            </li>
                            <li>
                                <span class="holiday-date">May 26</span>
                                <span class="holiday-name">Memorial Day</span>
                            </li>
                        </ul>
                    </div>

                    <div class="holiday-region">
                        <h3>Ontario, Canada</h3>
                        <ul class="holiday-list">
                            <li>
                                <span class="holiday-date">Jan 20</span>
                                <span class="holiday-name">Family Day</span>
                            </li>
                            <li>
                                <span class="holiday-date">Mar 17</span>
                                <span class="holiday-name">St. Patrick's Day (obs.)</span>
                            </li>
                            <li>
                                <span class="holiday-date">May 19</span>
                                <span class="holiday-name">Victoria Day</span>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <footer class="footer">
        <p>&copy; 2026 Ski Intel. Stay safe on the slopes!</p>
    </footer>

    <script>
        const ELLICOTTVILLE_LAT = 42.2773;
        const ELLICOTTVILLE_LON = -78.6706;
        const WEATHER_REFRESH_MS = 6 * 60 * 60 * 1000; // 6 hours
        const NOAA_REFRESH_MS = 6 * 60 * 60 * 1000; // 6 hours
        const BORDER_REFRESH_MS = 5 * 60 * 1000; // 5 minutes

        const weatherCodeMap = {
            0: 'Clear',
            1: 'Mainly Clear',
            2: 'Partly Cloudy',
            3: 'Overcast',
            45: 'Foggy',
            48: 'Foggy',
            51: 'Light Drizzle',
            53: 'Drizzle',
            55: 'Heavy Drizzle',
            61: 'Light Rain',
            63: 'Rain',
            65: 'Heavy Rain',
            71: 'Light Snow',
            73: 'Snow',
            75: 'Heavy Snow',
            77: 'Snow Grains',
            80: 'Light Showers',
            81: 'Showers',
            82: 'Heavy Showers',
            85: 'Light Snow Showers',
            86: 'Snow Showers',
            95: 'Thunderstorm',
            96: 'Thunderstorm with Hail',
            99: 'Thunderstorm with Hail'
        };

        function formatRelativeTime(date) {
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);

            if (minutes < 1) return 'just now';
            if (minutes < 60) return `${minutes}m ago`;
            if (hours < 24) return `${hours}h ago`;
            return `${days}d ago`;
        }

        function updateRelativeTimes() {
            const weatherTime = localStorage.getItem('weather-timestamp');
            const noaaTime = localStorage.getItem('noaa-timestamp');
            const borderTime = localStorage.getItem('border-timestamp');

            if (weatherTime) {
                document.getElementById('weather-updated').textContent = 
                    `Updated ${formatRelativeTime(new Date(parseInt(weatherTime)))}`;
            }

            if (noaaTime) {
                document.getElementById('noaa-updated').textContent = 
                    `Updated ${formatRelativeTime(new Date(parseInt(noaaTime)))}`;
            }

            if (borderTime) {
                document.getElementById('border-updated').textContent = 
                    `Updated ${formatRelativeTime(new Date(parseInt(borderTime)))}`;
            }
        }

        async function fetchWeatherData() {
            try {
                const url = `https://api.open-meteo.com/v1/forecast?latitude=${ELLICOTTVILLE_LAT}&longitude=${ELLICOTTVILLE_LON}&current=temperature_2m,weather_code,wind_speed_10m,precipitation&temperature_unit=celsius&wind_speed_unit=kmh`;
                
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                const current = data.current;

                const weatherHTML = `
                    <div class="info-item">
                        <span class="label">Temperature</span>
                        <span class="value">${current.temperature_2m.toFixed(1)}¬∞C</span>
                    </div>
                    <div class="info-item">
                        <span class="label">Conditions</span>
                        <span class="value">${weatherCodeMap[current.weather_code] || 'Unknown'}</span>
                    </div>
                    <div class="info-item">
                        <span class="label">Wind Speed</span>
                        <span class="value">${current.wind_speed_10m.toFixed(1)} km/h</span>
                    </div>
                    <div class="info-item">
                        <span class="label">Precipitation</span>
                        <span class="value">${current.precipitation.toFixed(1)} mm</span>
                    </div>
                `;

                document.getElementById('weather-data').innerHTML = weatherHTML;
                document.getElementById('weather-error').style.display = 'none';
                
                localStorage.setItem('weather-timestamp', Date.now().toString());
                localStorage.setItem('weather-data', JSON.stringify(current));
                
                updateRelativeTimes();
            } catch (error) {
                console.error('Weather fetch error:', error);
                document.getElementById('weather-error').textContent = 
                    `‚ö†Ô∏è Unable to load weather data: ${error.message}`;
                document.getElementById('weather-error').style.display = 'block';
                
                const cached = localStorage.getItem('weather-data');
                if (cached) {
                    const current = JSON.parse(cached);
                    const weatherHTML = `
                        <div class="info-item">
                            <span class="label">Temperature</span>
                            <span class="value">${current.temperature_2m.toFixed(1)}¬∞C</span>
                        </div>
                        <div class="info-item">
                            <span class="label">Conditions</span>
                            <span class="value">${weatherCodeMap[current.weather_code] || 'Unknown'}</span>
                        </div>
                        <div class="info-item">
                            <span class="label">Wind Speed</span>
                            <span class="value">${current.wind_speed_10m.toFixed(1)} km/h</span>
                        </div>
                        <div class="info-item">
                            <span class="label">Precipitation</span>
                            <span class="value">${current.precipitation.toFixed(1)} mm</span>
                        </div>
                    `;
                    document.getElementById('weather-data').innerHTML = weatherHTML + '<p class="cached-note">(Cached data)</p>';
                }
            }
        }

        async function fetchNOAAData() {
            try {
                const pointUrl = `https://api.weather.gov/points/${ELLICOTTVILLE_LAT},${ELLICOTTVILLE_LON}`;
                const pointResponse = await fetch(pointUrl);
                if (!pointResponse.ok) throw new Error(`HTTP ${pointResponse.status}`);
                
                const pointData = await pointResponse.json();
                const stationUrl = pointData.properties.observationStations;
                
                const stationResponse = await fetch(stationUrl);
                if (!stationResponse.ok) throw new Error(`HTTP ${stationResponse.status}`);
                
                const stationData = await stationResponse.json();
                const stationId = stationData.features[0]?.id;
                
                if (!stationId) throw new Error('No station found');
                
                const obsUrl = `${stationId}/observations/latest`;
                const obsResponse = await fetch(obsUrl);
                if (!obsResponse.ok) throw new Error(`HTTP ${obsResponse.status}`);
                
                const obsData = await obsResponse.json();
                const snowDepth = obsData.properties.snowDepth?.value;
                
                let snowDepthCm = 'N/A';
                let change24h = 'N/A';
                
                if (snowDepth !== null && snowDepth !== undefined) {
                    snowDepthCm = (snowDepth * 100).toFixed(1);
                    
                    const prevDepth = localStorage.getItem('noaa-prev-depth');
                    if (prevDepth !== null) {
                        const diff = snowDepth - parseFloat(prevDepth);
                        change24h = (diff > 0 ? '+' : '') + (diff * 100).toFixed(1);
                    }
                    localStorage.setItem('noaa-prev-depth', snowDepth.toString());
                } else {
                    snowDepthCm = 'No data';
                }

                const noaaHTML = `
                    <div class="info-item">
                        <span class="label">Snow Depth</span>
                        <span class="value">${snowDepthCm}${snowDepthCm !== 'No data' && snowDepthCm !== 'N/A' ? ' cm' : ''}</span>
                    </div>
                    <div class="info-item">
                        <span class="label">24h Change</span>
                        <span class="value">${change24h}${change24h !== 'N/A' ? ' cm' : ''}</span>
                    </div>
                `;

                document.getElementById('noaa-data').innerHTML = noaaHTML;
                document.getElementById('noaa-error').style.display = 'none';
                
                localStorage.setItem('noaa-timestamp', Date.now().toString());
                localStorage.setItem('noaa-data', JSON.stringify({ snowDepth, change24h }));
                
                updateRelativeTimes();
            } catch (error) {
                console.error('NOAA fetch error:', error);
                document.getElementById('noaa-error').textContent = 
                    `‚ö†Ô∏è Unable to load NOAA data: ${error.message}`;
                document.getElementById('noaa-error').style.display = 'block';
                
                const cached = localStorage.getItem('noaa-data');
                if (cached) {
                    const data = JSON.parse(cached);
                    const noaaHTML = `
                        <div class="info-item">
                            <span class="label">Snow Depth</span>
                            <span class="value">${data.snowDepth !== null ? (data.snowDepth * 100).toFixed(1) + ' cm' : 'No data'}</span>
                        </div>
                        <div class="info-item">
                            <span class="label">24h Change</span>
                            <span class="value">${data.change24h} cm</span>
                        </div>
                    `;
                    document.getElementById('noaa-data').innerHTML = noaaHTML + '<p class="cached-note">(Cached data)</p>';
                }
            }
        }

        async function fetchBorderWaitTimes() {
            try {
                const response = await fetch('https://bwt.cbp.gov/api/bwtpublic');
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                
                const portMap = {
                    '090109': 'Peace Bridge',
                    '090110': 'Rainbow Bridge', 
                    '090111': 'Whirlpool Rapids Bridge',
                    '090112': 'Lewiston-Queenston Bridge'
                };
                
                const relevantPorts = ['090109', '090110', '090111', '090112'];
                let borderHTML = '';
                let portCount = 0;
                
                data.forEach((port) => {
                    if (relevantPorts.includes(port.port_number)) {
                        const portName = portMap[port.port_number] || port.port_name;
                        const passengerDelay = parseInt(port.passenger_vehicle_delay) || 0;
                        
                        let delayClass = 'wait-low';
                        if (passengerDelay > 30) delayClass = 'wait-high';
                        else if (passengerDelay > 15) delayClass = 'wait-moderate';
                        
                        if (portCount > 0) borderHTML += '<hr>';
                        
                        borderHTML += `
                            <div class="border-item">
                                <div class="border-name">${portName}</div>
                                <div class="wait-time">
                                    <span class="direction">Passenger Vehicles:</span>
                                    <span class="time ${delayClass}">${passengerDelay} min</span>
                                </div>
                            </div>
                        `;
                        
                        portCount++;
                    }
                });
                    }
                });

                if (borderHTML) {
                    document.getElementById('border-data').innerHTML = borderHTML;
                    document.getElementById('border-error').style.display = 'none';
                    
                    localStorage.setItem('border-timestamp', Date.now().toString());
                    localStorage.setItem('border-data', borderHTML);
                    
                    updateRelativeTimes();
                } else {
                    throw new Error('No bridge data found');
                }
            } catch (error) {
                console.error('Border wait times fetch error:', error);
                
                // CORS error likely - provide manual alternative
                const manualHTML = `
                    <div class="border-manual">
                        <p class="border-cors-notice">‚ö†Ô∏è Unable to load live data due to browser security restrictions.</p>
                        <p class="border-instruction">Visit <a href="https://bwt.cbp.gov/ViewAllPorts.html?com=1&pas=1&ped=1&plist=0901" target="_blank" rel="noopener noreferrer" class="border-link">CBP Border Wait Times</a> for live updates.</p>
                    </div>
                `;
                
                document.getElementById('border-error').style.display = 'none';
                
                const cached = localStorage.getItem('border-data');
                if (cached && !cached.includes('border-manual')) {
                    document.getElementById('border-data').innerHTML = cached + '<p class="cached-note">(Cached data)</p>';
                } else {
                    document.getElementById('border-data').innerHTML = manualHTML;
                }
            }
        }

        function shouldRefresh(timestampKey, intervalMs) {
            const lastUpdate = localStorage.getItem(timestampKey);
            if (!lastUpdate) return true;
            return (Date.now() - parseInt(lastUpdate)) > intervalMs;
        }

        function initData() {
            if (shouldRefresh('weather-timestamp', WEATHER_REFRESH_MS)) {
                fetchWeatherData();
            } else {
                const cached = localStorage.getItem('weather-data');
                if (cached) {
                    const current = JSON.parse(cached);
                    const weatherHTML = `
                        <div class="info-item">
                            <span class="label">Temperature</span>
                            <span class="value">${current.temperature_2m.toFixed(1)}¬∞C</span>
                        </div>
                        <div class="info-item">
                            <span class="label">Conditions</span>
                            <span class="value">${weatherCodeMap[current.weather_code] || 'Unknown'}</span>
                        </div>
                        <div class="info-item">
                            <span class="label">Wind Speed</span>
                            <span class="value">${current.wind_speed_10m.toFixed(1)} km/h</span>
                        </div>
                        <div class="info-item">
                            <span class="label">Precipitation</span>
                            <span class="value">${current.precipitation.toFixed(1)} mm</span>
                        </div>
                    `;
                    document.getElementById('weather-data').innerHTML = weatherHTML;
                }
            }

            if (shouldRefresh('noaa-timestamp', NOAA_REFRESH_MS)) {
                fetchNOAAData();
            } else {
                const cached = localStorage.getItem('noaa-data');
                if (cached) {
                    const data = JSON.parse(cached);
                    const noaaHTML = `
                        <div class="info-item">
                            <span class="label">Snow Depth</span>
                            <span class="value">${data.snowDepth !== null ? (data.snowDepth * 100).toFixed(1) + ' cm' : 'No data'}</span>
                        </div>
                        <div class="info-item">
                            <span class="label">24h Change</span>
                            <span class="value">${data.change24h} cm</span>
                        </div>
                    `;
                    document.getElementById('noaa-data').innerHTML = noaaHTML;
                }
            }

            if (shouldRefresh('border-timestamp', BORDER_REFRESH_MS)) {
                fetchBorderWaitTimes();
            } else {
                const cached = localStorage.getItem('border-data');
                if (cached) {
                    document.getElementById('border-data').innerHTML = cached;
                }
            }

            updateRelativeTimes();
        }

        document.addEventListener('DOMContentLoaded', () => {
            initData();
            setInterval(updateRelativeTimes, 60000);
            setInterval(() => {
                if (shouldRefresh('weather-timestamp', WEATHER_REFRESH_MS)) {
                    fetchWeatherData();
                }
            }, 60000);
            setInterval(() => {
                if (shouldRefresh('noaa-timestamp', NOAA_REFRESH_MS)) {
                    fetchNOAAData();
                }
            }, 60000);
            setInterval(() => {
                if (shouldRefresh('border-timestamp', BORDER_REFRESH_MS)) {
                    fetchBorderWaitTimes();
                }
            }, 60000);
        });
    </script>
</body>
</html>
